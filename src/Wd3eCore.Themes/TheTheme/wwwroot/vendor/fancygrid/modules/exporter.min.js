Fancy.define("Fancy.grid.plugin.Exporter",{extend:Fancy.Plugin,ptype:"grid.exporter",inWidgetName:"exporter",csvSeparator:",",csvHeader:!1,csvFileName:"export",excelFileName:"export",constructor:function(a){this.Super("const",arguments),Fancy.fullBuilt&&Fancy.loadModule("excel")},init:function(){},exportToExcel:function(a){function b(a){for(var b=new ArrayBuffer(a.length),c=new Uint8Array(b),d=0;d!=a.length;++d)c[d]=255&a.charCodeAt(d);return b}var c=this,d=c.widget,a=a||{},e=c.getColumnsData(),f=c.getData(),g=!1===a.header?f:[e].concat(f),h=function(){if(!(this instanceof h))return new h;this.SheetNames=[],this.Sheets={}},i=new h,j=c.sheet_from_array_of_arrays(g);j["!cols"]=[],Fancy.each(c.widths,function(a){j["!cols"].push({wch:a})});var k=d.title;a.fileName?k=a.fileName:Fancy.isObject(k)&&(k=k.text);var l=k||c.excelFileName;i.SheetNames.push(l),i.Sheets[l]=j;var m=XLSX.write(i,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([b(m)],{type:"application/octet-stream"}),l+".xlsx")},getColumnsData:function(){var a=this,b=a.widget,c=[].concat(b.leftColumns).concat(b.columns).concat(b.rightColumns),d=[];return a.widths=[],Fancy.each(c,function(b){"$selected"!==b.index&&(a.widths.push(b.width),d.push(b.title||""))}),d},getData:function(){var a=this,b=a.widget,c=[],d=b.getDisplayedData();return Fancy.each(d,function(a){var b=[];Fancy.each(a,function(a){b.push(a)}),c.push(b)}),c},sheet_from_array_of_arrays:function(a,b){for(var c={},d={s:{c:1e7,r:1e7},e:{c:0,r:0}},e=0,f=a.length,g=function(a,b){return b&&(a+=1462),(Date.parse(a)-new Date(Date.UTC(1899,11,30)))/864e5};e!=f;++e)for(var h=0;h!=a[e].length;++h){d.s.r>e&&(d.s.r=e),d.s.c>h&&(d.s.c=h),d.e.r<e&&(d.e.r=e),d.e.c<h&&(d.e.c=h);var i={v:a[e][h]};if(null!=i.v){var j=XLSX.utils.encode_cell({c:h,r:e});"number"==typeof i.v?i.t="n":"boolean"==typeof i.v?i.t="b":i.v instanceof Date?(i.t="n",i.z=XLSX.SSF._table[14],i.v=g(i.v)):i.t="s",c[j]=i}}return d.s.c<1e7&&(c["!ref"]=XLSX.utils.encode_range(d)),c},getDataAsCsv:function(a){var b=this,c=b.widget,d=b.getData(),e="",a=a||{},f=a.separator||b.csvSeparator;if(a.header||b.csvHeader){var g=function(a){a.hidden||(e+='"'+(a.title||"")+'"'+f)};Fancy.each(c.leftColumns,g),Fancy.each(c.columns,g),Fancy.each(c.rightColumns,g),e=e.substring(0,e.length-1),e+="\r\n"}return Fancy.each(d,function(a,b){Fancy.each(a,function(a,b){Fancy.isString(a)&&(a='"'+a+'"'),e+=a+f}),e=e.substring(0,e.length-1),e+="\r\n"}),e},exportToCSV:function(a){var b=this,a=(b.widget,a||{}),c=b.getDataAsCsv(a),d=a.fileName||b.csvFileName,e=new Blob([c],{type:"text/csv;charset=utf-8;"});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,d);else{var f=document.createElement("a");f.href=window.URL.createObjectURL(e),f.download=d+".csv",document.body.appendChild(f),f.click(),document.body.removeChild(f)}}});