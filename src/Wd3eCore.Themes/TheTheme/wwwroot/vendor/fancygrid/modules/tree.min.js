Fancy.Mixin("Fancy.store.mixin.Tree",{initTreeData:function(){var a=this;if(a.isTree=!0,a.data&&0!==a.data.length){var b;b=Fancy.isObject(a.data)?a.treeReadData(a.data.items):a.treeReadData(a.data),a.setData(b)}else;},treeReadData:function(a,b,c){var d=this,e=[];return b=b||1,Fancy.each(a,function(a){a.data&&(a=a.data),a.$deep=b,a.leaf=!!a.leaf,a.expanded=!!a.expanded,Fancy.isArray(a.filteredChild)&&a.filteredChild.length?a.leaf=!1:a.child&&a.child.length&&(a.leaf=!1),c&&(a.parentId=c),a.id||(Fancy.idSeed++,a.id=Fancy.idSeed+1e3),e.push(a),a.expanded&&(e=e.concat(d.treeReadData(a.child||[],b+1,a.id)))}),e},treeGetDataAsTree:function(){var a=this,b=[];return Fancy.each(a.data,function(a){1===a.get("$deep")&&b.push(a)}),b},treeSort:function(a,b,c,d){var e=this,f=[],g=[],h={},i=[];Fancy.each(a,function(a){var b=a.data||a;f.push(b[c]),void 0===h[b[c]]?h[b[c]]=a:(Fancy.isArray(h[b[c]])||(h[b[c]]=[h[b[c]]]),h[b[c]].push(a))});var j=!1,k=!1;if(f.length){j=!0,k=!0;var l;Fancy.each(a,function(a,b){var d=a.data||a;""!==d[c]&&(j=!1),void 0!==l&&l!==d[c]&&(k=!1),l=d[c]})}if("number"===d)switch(b){case"asc":g=Fancy.Array.copy(f).sort(function(a,b){return a-b});break;case"desc":g=Fancy.Array.copy(f).sort(function(a,b){return b-a})}else switch(b){case"asc":g=Fancy.Array.copy(f).sort();break;case"desc":g=Fancy.Array.copy(f).sort(),g=g.reverse()}return Fancy.each(g,function(f,g){var l=h[f];Fancy.isArray(l)&&(l=l.splice(0,1)[0]),(j||k)&&(l=a[g]);var m=l.data||l;m.child&&m.expanded&&(l.data.sorted=e.treeSort(m.child,b,c,d)),i.push(l)}),i},treeReadSortedId:function(a){var b=this,c=[];return Fancy.each(a,function(a,d){c.push(a.id),a=b.getById(a.id),a.data.expanded&&(a.data.sorted?c=c.concat(b.treeReadSortedId(a.data.sorted)):a.data.child&&(c=c.concat(b.treeReadSortedId(a.data.child))))}),c},treeReBuildData:function(){var a=this,b=[],c=[];Fancy.each(a.data,function(a){1===a.get("$deep")&&b.push(a.data)}),c=a.treeReadData(b),a.setData(c)}}),function(){var a=function(b,c){c=c||0;var d=this,e=d.widget;return Fancy.each(b,function(b){c++;var f=b.data?b.data:b;e.store.filteredData?f.id&&e.store.map[f.id]&&(f=e.store.map[f.id].data):f=e.getById(f.id).data;var g=f.child;g&&f.expanded&&(c+=a.apply(d,[g]))}),c};Fancy.define("Fancy.grid.plugin.Tree",{extend:Fancy.Plugin,ptype:"grid.tree",inWidgetName:"tree",singleExpand:!1,constructor:function(a){this.Super("const",arguments)},init:function(){var a=this;a.expandMap={},a.Super("init",arguments),a.ons()},ons:function(){var a=this,b=a.widget;b.once("init",function(){b.on("rowdblclick",a.onRowDBLClick,a),b.on("cellclick",a.onTreeExpanderClick,a),b.on("beforesort",a.onBeforeSort,a)})},onRowDBLClick:function(a,b){var c=this,d=c.widget,e=b.item;if(!(e.get("leaf")||d.edit&&2===d.edit.clicksToEdit)){e.get("expanded")?c.collapseRow(b.item):c.expandRow(b.item)}},onTreeExpanderClick:function(a,b){var c=this,d=b.item;Fancy.get(b.e.target).hasClass("fancy-grid-tree-expander")&&!d.get("leaf")&&(d.get("expanded")?c.collapseRow(b.item):c.expandRow(b.item))},collapseRow:function(b){var c=this,d=c.widget,e=d.store,f=b.get("child"),g=(b.get("filteredChild"),b.get("id"));c.expandMap[g]=!1,b.set("expanded",!1);var h=e.getRow(b.get("id")),i=0,j=a.apply(this,[f]);if(e.filteredData){var k,l=b.get("id"),m={};m[l]=!0;for(var n,i=0,j=e.data.length;i<j&&(b=e.data[i],!(n&&n>=b.data.$deep));i++){if(m[b.data.parentId]){n||(n=b.data.$deep-1),k||(k=i);var o=e.data.splice(k,1)[0];o.data.child&&(m[o.data.id]=!0),delete e.map[o.id],i--,j--}b.data.child&&n&&(m[b.data.id]=!0)}e.order&&(delete e.order,delete e.filterOrder,e.reSort()),e.changeDataView()}else{for(d.store.treeCollapsing=!0;i<j;i++)d.removeAt(h+1);delete d.store.treeCollapsing}d.update()},expandRow:function(a){var b=this,c=b.widget,d=c.store,e=a.get("child"),f=(a.get("filteredChild"),a.get("id")),g=a.get("parentId");if(b.singleExpand)if(g){var h=c.getById(g),i=h.get("child");Fancy.each(i,function(a){var d=a.get("expanded");void 0!==b.expandMap[a.id]&&(d=b.expandMap[a.id]),!0===d&&b.collapseRow(c.getById(a.id))})}else{var i=c.findItem("parentId","");Fancy.each(i,function(a){var c=a.get("expanded");void 0!==b.expandMap[a.id]&&(c=b.expandMap[a.id]),!0===c&&b.collapseRow(a)})}b.expandMap[f]=!0,a.set("expanded",!0);var j=d.getRow(a.get("id")),k=a.get("$deep")+1,l=!1;if(d.filteredData){var m=a.get("id");Fancy.each(d.data,function(a,b){if(a.id===m)return j=b,!0})}var n=function(a,d,e,g){return g=g||f,Fancy.each(a,function(a,f){var h=a.data;a.data||(l=!0,h=a),h.$deep=e,h.parentId=g;var i=h.expanded;if(void 0!==b.expandMap[h.id]&&(i=b.expandMap[h.id],h.expanded=i),d++,c.insert(d,h),!0===i){var j=h.child;h.filteredChild,d=n(j,d,e+1,h.id)}}),d};c.store.treeExpanding=!0,n(e,j,k),delete c.store.treeExpanding,l&&Fancy.each(a.data.child,function(b,c){var e=d.getById(b.id);void 0!==e&&(a.data.child[c]=e)}),c.update(),d.sorters&&d.order&&(delete d.order,delete d.filterOrder,d.reSort())},onBeforeSort:function(a,b){var c=this;"drop"===b.action&&c.onDropSort()},onDropSort:function(){this.widget.store.treeReBuildData()}})}();